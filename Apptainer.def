Bootstrap: docker
From: carlomt/geant4:{{ TAG }}

%arguments
    TAG=11.3.2-almalinux9
    PROJECT_NAME=G4TestGeneric

%labels
    Author Carlo Mancini
    Email mancinit@infn.it
    Project {{ PROJECT_NAME }}
    Description "Apptainer container for {{ PROJECT_NAME }}"

%files
    . /source

%setup
    mkdir -p "$APPTAINER_ROOTFS/cvmfs"
    mkdir -p "$APPTAINER_ROOTFS/home/runner/_diag"
    mkdir -p "$APPTAINER_ROOTFS/home/runner/_work"

%environment
    export G4DATA_DIR=/g4data
    export G4INSTALL=/usr/local
    export LD_LIBRARY_PATH=/usr/local/lib64:$LD_LIBRARY_PATH
    export CMAKE_PREFIX_PATH=/usr/local:$CMAKE_PREFIX_PATH
    export PATH=/usr/local/bin:$PATH

%post
    set -e
    mkdir build && cd build
    cmake -DPROJECT_NAME_OVERRIDE="{{ PROJECT_NAME }}" ../source
    make -j"$(nproc)"
    make install

%runscript
    echo "Running {{ PROJECT_NAME }} simulation..."
    /usr/local/bin/{{ PROJECT_NAME }} "$@"
